// Utility functions for copy link and mobile menu toggle
function copySectionLink(sectionId) {
  const url = window.location.origin + window.location.pathname + '#' + sectionId;
  
  navigator.clipboard.writeText(url).then(() => {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '✓ Copied!';
    button.style.opacity = '1';
    
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy link:', err);
    const textArea = document.createElement('textarea');
    textArea.value = url;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '✓ Copied!';
      button.style.opacity = '1';
      setTimeout(() => {
        button.innerHTML = originalText;
      }, 2000);
    } catch (err2) {
      console.error('Fallback copy failed:', err2);
    }
    document.body.removeChild(textArea);
  });
}

function toggleMobileMenu() {
  const mobileNav = document.getElementById('mobile-nav');
  const btn = document.querySelector('.mobile-menu-btn');
  const isOpen = mobileNav.classList.contains('show');
  const header = document.querySelector('.sticky-header');
  
  function updateHeaderHeight() {
    if (header) {
      const height = header.offsetHeight;
      document.documentElement.style.setProperty('--header-height', height + 'px');
    }
  }
  
  if (isOpen) {
    mobileNav.classList.remove('show');
    btn.setAttribute('aria-expanded', 'false');
    setTimeout(updateHeaderHeight, 50);
  } else {
    mobileNav.classList.add('show');
    btn.setAttribute('aria-expanded', 'true');
    setTimeout(updateHeaderHeight, 50);
  }
}

// Prevent browser scroll restoration
if ('scrollRestoration' in history) {
  history.scrollRestoration = 'manual';
}

/* Bootstrap: header height & immediate navigation */
(function(){
  try {
    var header = document.querySelector('.sticky-header');
    function setHeaderVar(){
      if (!header) header = document.querySelector('.sticky-header');
      if (header) {
        var h = header.offsetHeight || 0;
        document.documentElement.style.setProperty('--header-height', h + 'px');
      }
    }
    setHeaderVar();
    document.addEventListener('DOMContentLoaded', setHeaderVar, {once:true});
    window.addEventListener('load', setHeaderVar, {once:true});
    if (document.fonts && document.fonts.ready) { document.fonts.ready.then(setHeaderVar); }
    window.addEventListener('resize', setHeaderVar);
    
    function getHeaderOffset(){
      var cssVar = getComputedStyle(document.documentElement).getPropertyValue('--header-height');
      var n = parseInt(cssVar) || (header ? header.offsetHeight : 0) || 0;
      return n;
    }
    
    function scrollToId(id, smooth){
      var el = document.getElementById(id);
      if (!el) return;
      var y = window.scrollY + el.getBoundingClientRect().top - getHeaderOffset() - 8;
      if (y < 0) y = 0;
      window.scrollTo({ top: y, behavior: smooth ? 'smooth' : 'auto' });
    }
    
    function wireLinks(root){
      (root || document).querySelectorAll('.quick-nav-links a[href^="#"], .mobile-quick-nav a[href^="#"]').forEach(function(a){
        if (a.__wired) return;
        a.__wired = true;
        a.addEventListener('click', function(e){
          e.preventDefault();
          var id = (a.getAttribute('href') || '').slice(1);
          if (!id) return;
          history.replaceState(null, '', '#' + id);
          scrollToId(id, true);
        });
      });
    }
    
    wireLinks();
    var mo = new MutationObserver(function(muts){
      muts.forEach(function(m){ if (m.addedNodes && m.addedNodes.length) wireLinks(m.target); });
    });
    mo.observe(document.body || document.documentElement, { subtree:true, childList:true });
    
    if (window.location.hash) {
      var id = window.location.hash.slice(1);
      requestAnimationFrame(function(){
        setHeaderVar();
        scrollToId(id, false);
      });
    }
  } catch(e) {}
})();

// Accessibility: Close mobile menu with Escape key
document.addEventListener('keydown', function(e){
  if(e.key === 'Escape'){
    const mobileNav = document.getElementById('mobile-nav');
    const btn = document.querySelector('.mobile-menu-btn');
    if(mobileNav && mobileNav.classList.contains('show')){
      mobileNav.classList.remove('show');
      if(btn){
        btn.setAttribute('aria-expanded', 'false');
        btn.focus();
      }
    }
  }
});
