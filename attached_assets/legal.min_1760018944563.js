(function(){const header=document.querySelector('.sticky-header');const linksContainer=document.querySelector('.quick-nav-links');const mobileNav=document.getElementById('mobile-nav');function getHeaderOffset(){const h=header ? header.offsetHeight:0;const cssVar=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height'))|| 0;return Math.max(h,cssVar);}function scrollToSection(id){const el=document.getElementById(id);if(!el)return;const headerOffset=getHeaderOffset();const rect=el.getBoundingClientRect();const targetY=window.scrollY+rect.top-headerOffset-8;window.scrollTo({top:targetY,behavior:'smooth'});}if(linksContainer){linksContainer.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener('click',function(e){e.preventDefault();const id=this.getAttribute('href').slice(1);scrollToSection(id);history.replaceState(null,'','#'+id);});});}function rebuildMobile(){if(!linksContainer || !mobileNav)return;mobileNav.innerHTML='';linksContainer.querySelectorAll('a').forEach(link=>{const a=document.createElement('a');a.href=link.getAttribute('href');a.textContent=link.textContent;a.addEventListener('click',(e)=>{e.preventDefault();const id=a.getAttribute('href').slice(1);mobileNav.classList.remove('show');history.replaceState(null,'','#'+id);requestAnimationFrame(()=>scrollToSection(id));});mobileNav.appendChild(a);});}rebuildMobile();const sections=Array.from(document.querySelectorAll('main section[id]'));const linkMap=new Map();function mapLinks(){document.querySelectorAll('.quick-nav-links a,.mobile-quick-nav a').forEach(a=>{const id=(a.getAttribute('href')||'').replace('#','');if(id){if(!linkMap.has(id))linkMap.set(id,[]);linkMap.get(id).push(a);}});}mapLinks();function setActive(id){document.querySelectorAll('.quick-nav-link,.mobile-quick-nav a').forEach(a=>a.classList.remove('active'));(linkMap.get(id)|| []).forEach(a=>a.classList.add('active'));}const observer=new IntersectionObserver((entries)=>{const visible=entries .filter(e=>e.isIntersecting).sort((a,b)=>a.boundingClientRect.top-b.boundingClientRect.top);if(visible.length){const id=visible[0].target.id;setActive(id);history.replaceState(null,'','#'+id);}},{rootMargin:`-${getHeaderOffset()+12}px 0px-70% 0px`,threshold:[0.1,0.6]});sections.forEach(sec=>observer.observe(sec));if(window.location.hash){const id=window.location.hash.slice(1);setTimeout(()=>{setActive(id);scrollToSection(id);},150);}window.addEventListener('resize',()=>{document.documentElement.style.setProperty('--header-height',(header? header.offsetHeight:0)+'px');});})();